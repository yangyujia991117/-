# 项目

## 学乎

和苏州实验中学合作的项目，我们教授高中生完整的软件开发流程，包括需求工程、原型设计、编码、测试与维护，带领同学们在体验完整的软件过程的同时，完善小程序的设计，并进行代码实现。让同学们了解软件工程相关技术，初步建立软件工程思维。

这个小程序一共分成四个模块：我的、问答、分享和树洞，除了一个“我的”模块是用来给用户进行消息管理以及查看历史发帖记录的之外，其余三个模块本质上都是一个具有发帖、回复、点赞功能的论坛，比如说在“问答”模块同学们可以发布带若干张图片的问题，其他人可以进行回帖和点赞，这个回帖也是可以带若干张图片的，如果有回帖或者点赞，帖子的楼主就会收到通知。“分享”模块也是一个发帖和回帖的论坛，它和“问答”模块的区别在于“问答”模块的内容侧重学习提问，“分享”模块的内容侧重生活分享。最后一个“树洞”模块我们交给同学们完成，让他们参考前两个模块的功能及实现，结合之前获取的需求和原型设计，分组完成“树洞”模块的实现。

最后两个组的同学都完成了“树洞”模块的全部实现，并且他们实现的功能和效果有所不同，比如有一个组是只能匿名发帖，然后他们的前端界面也不同。

### 难点：如何发布及存储带图片的帖子

为了教学方便，使用微信云存储及云数据库。

每篇帖子的图片存在云存储中，步骤如下：

1.通过`wx.chooseImage`选择图片，可以拍照或上传本地图片，选择图片之后会获得一个临时路径

2.通过`wx.cloud.uploadFile`将图片上传至云存储中，得到在云存储中的fileID

​	<font color="red">在这里又遇到一个困难就是wx.cloud.uploadFile的上传操作是异步的，因此上传图片的顺序会乱掉，解决办法是在上传之前给图片一个编号，等返回fileID之后根据图片编号重新调整fileID顺序。</font>

3.通过`wx.cloud.getTempFileURL`或的图片真实的https地址，得到所有图片的https地址的数组

4.上传图片完毕后，再将这个帖子存到数据库，数据库中的帖子集合包含以下字段：

![image-20230404154947594](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230404154947594.png)



### 可以改进的地方

容易做到的：可以给回帖进行再回帖

难以做到的：在帖子的任意位置插入图片，但感觉实现起来会比较困难



## 游戏

如今繁荣的游戏市场中触屏游戏很常见，但使用笔进行交互的游戏却通常局限于绘画类游戏，且缺少将笔式和触屏交互相结合的3D物体操作类游戏。将笔式交互和触屏交互相结合应用于3D 游戏中，既能发挥笔式交互精确、不易疲劳等优点，又能发挥触屏交互方便快捷、输入带宽高、可拓展性高等
优点，从而提高游戏中3D 物体的操作效率，增强游戏的体验性。

**游戏内容：**设置若干个关卡，每个关卡都提供若干个物品，玩家通过笔式和触屏交互把这些物品堆叠到合适的高度，保持平衡一段时间后通关，物品触碰到地板则血量-1，血量减为0就失败，每一关还有倒计时，倒计时为0也失败。

### 难点1：设计触屏手势

我们查找了很多论文，也在各大游戏平台里寻找，并未发现结合笔式和触屏交互进行3D物体操纵的游戏，所以等于我们必须从0开始设计这个游戏。在游戏中笔主要用来在平行于屏幕的平面内拖拽，所以对物体的远近调节和旋转需要通过触屏。

触屏手势的设计参考了大量相关论文，最后决定用二指捏放手势进行远近调节，用单指滑动手势进行旋转。

### 难点2：区分施加在物体上的笔操作输入与施加在任何地方的触屏手势输入

本人尝试的第一种分离方法为在摄像机上添加TouchScript 的Fullscreen-Layer 组件，因为该组件能够识别整个画面的手势，但这样做之后发现直接添加在物品上的Gesture 均失效，无法识别到直接施加在物品上的所有手势。之后又尝试了多种方法也不成功。最后只能选择在场景后方放置一块很大的平面来单独接受触屏输入，该平面设置为透明。

使用TouchScript插件获取输入：在物体上添加TapGesture组件获取点击选择输入，添加TransformGesture组件获取笔的拖拽输入；在透明平面上添加两个TransformGesture，一个获取二指缩放输入，一个获取单指滑动输入。

### 难点3：将施加在二维屏幕上的触屏输入转化为物体在垂直屏幕方向的运动

当透明平面上负责接收二指捏放输入的TransformGesture检测到输入时就会让物体产生远近移动的动作，在我们的设计中此时物体应该是在一个<font color="red">平行于游戏中场景地面（也可以是垂直于电脑屏幕）</font>的方向进行远近调节，而TransformGesture获取到的输入是二维的，只包含xy两个维度，因此要将这一二维输入转为物体在第三维上的变换：

![image-20230404162102960](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230404162102960.png)

TouchScript的自带示例中DeltaScale这个属性是用来对物体进行放大缩小，我是受到了进大远小的启发，利用这个属性做远近调节。

由于场景的主镜头存在旋转，所以不能通过直接更改物体坐标的z 值来实现远近调节，不然画面效果显示会不正确，应该根据主镜头的旋转找到真正相对移动的坐标轴。具体方法为：
**用<font color="red">Camera.Main.transform.rotation.eulerAngles.y 获取主镜头沿y 轴旋转的值cameraY</font>，Quaternion.Euler (0,cameraY,0) 与向量(0,0,v) 相乘的结果**即为物体坐标的变换量，其中v 为物体的深度移动量。

### 难点4：对物体进行旋转

与上一个功能类似，在实现该功能时遇到的最大问题是主镜头存在移动与旋转，因此不能让物体沿着世界坐标系的x 轴或y 轴旋转，不然画面效果显示会不正确，应该根据主镜头的移动与旋转找到真正用于物体旋转的“x 轴”与“y轴”, 具体方法为，**用<font color="red">Camera.Main.transform.rotation.eulerAngles.y</font> 获取主镜头沿y 轴旋转的值cameraY，Quaternion.Euler (0,cameraY,0) 与向量(1,0,0) 相乘的结果即为用于旋转的“x 轴”, Quaternion.Euler (0,cameraY,0) 与向量(0,1,0) 相乘的结果即为用于旋转的“y 轴”。**另外，在项目调试过程中，发现<font color="red">当camaraY < 90 或camaraY > 270 时，“y 轴”的y 值要取相反数。</font>
ScaleAndRotationZoom 上Limit Pointers 设为[1,1] 的TransformGesture 负责接收用于旋转的单指滑动手势。沿x方向的滑动量是绕y轴逆时针方向的旋转量，沿y方向的滑动量是绕x轴顺时针方向的旋转量。该TransformGesture 识别到单指滑动手势输入时就会调用ScaleAndRotate.cs 脚本的SingleRotate 方法，该方法的主要部分如下图所示，其中的singlePoint 即为TransformGesture，singlePoint.DeltaPosition为手势的滑动量。

![image-20230404162614852](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230404162614852.png)

### 难点5：物体在操作过程中没有深度感

本人最开始的尝试是给物体添加影子，但这一方法涉及复杂的贴图和灯光控制，效果不好，加之想到游戏场景的灯光较柔和且并非垂直向下投射，物体下方通常不会有明显的影子。因此，最后决定在当前被选中的物体下方画一条竖直向下的投影线，以显示物体当前所处的深度，该条投影线以8 帧显示一次的频率闪烁。

使用了LineRenderer 组件。



## 知识图谱智能问答模块

### 准备阶段

1. 智能问答的结果都是在口红商品表这一个表里面查询的，这个表的字段有品牌、色系、产地、价格、色号等等，我首先将智能问答中的关键词分为三种类型：列名、列值以及疑问词，列名就是这张商品表的字段名，也就是我刚才提到的品牌、色系、价格那些，列值就是这些字段的值，比如说品牌这个字段的值可以是“迪奥”、产地这个字段的值可以是”中国“，像迪奥、中国这种就叫列值，还有一类关键词是疑问词，包括”哪些“、”什么“、”多少“、”如何“、”怎样“、”介绍“。
2. 使用hanLP来进行分词以及依存关系分析，我是直接下载了hanLP的整个模型及词库，在本地通过import hanLP相关类来使用hanLP的方法，而不是通过调用网络API来进行hanLP的使用（使用调用网络接口很方便但是不便于进行关键词的扩充，也会受到网络性能的影响）。
3. 在hanLP的词库里添加关键词，也就是刚才提到的所有的列名、列值以及疑问词，保证这些词一定会被分出来。这里有两个例外就是价格及色号，因为价格有很多且是一个数字，所以肯定不能直接以关键词的形式添加进去，后面是用正则表达式判断它是价格的。
4. 创建一个新类**QGItem**作为后续句法树中的关键词节点，创建一个新类**QuestionGraph**问题图，这个图中每一个节点就是`QGItem`类型的，用来存储构建句法树之前的关键词依存关系，后面会通过删减这个图来进行句法树的构建。
5. 在传入问句之后，对其进行一些格式化操作，比如把一个特殊字符给去掉、将疑问词进行标准化等。

### 分词及构建句法树阶段

 1. 分词：调用`HanLP.parseDependency(question)`方法将问句进行分词，得到一个CoNLLSentence（也就是包含被分出来的所有词语及其所有信息的一个数组），遍历该CoNLLSentence中的每一个词语，判断是否是我们需要的关键词，如果是的话判断它的类型——列名/列值/疑问词，并对它们进行标记`（word.POSTAG）`

 2. 构建问题图：hanLP有一个依存句法分析功能，也就是能分析一句话中每个词语和其他词语的依存关系，如主谓关系、定中关系、并列关系等。再一次遍历CoNLLSentence，这次是只遍历被标记的关键词，每个关键词建立一个QGItem对象，放到问题图中，然后通过`word.HEAD`属性拿到和这个关键词具有依存关系的所有词语，将这个依存关系作为问题图的边。需要注意的是，因为关键词和非关键词也可能会有依存关系，所以和关键词具有依存关系的非关键词也要建立相应的QGItem对象，后面再约简掉。

    <font color="voilet">需要注意的是虽然它叫问题图，但实际上也是一棵树，因为hanLP构建出的句法依存关系本来就是一个树，这里我把他存为图的形式只是为了方便约简，也和最后构建的以疑问词为根的句法树相区别。</font>

 3. 约简问题图：将非关键词删掉，具体方法为：判断该非关键词节点在图中的度（边的数目），如果为1，那直接删除这个节点就好，如果为2，则连接与它相连的两个节点，如果为3，则把其中两个和它相连的节点连到另一个与它相连的关键词节点上面。

 4. 根据这个约简过的问题图，通过深度优先遍历构建最后的句法树，这个句法树以疑问词为根。

### 深度遍历句法树生成sql语句阶段：

1. 首先深度遍历句法树，将遍历结果存储

2. 根据遍历结果，替换一些中间值，例如“与MAC316色系相同的迪奥唇釉有哪些”，的句法树从根到最后一个节点为<font color="orange">哪些→唇釉→迪奥→色系→MAC316，“色系→MAC316”这一步会替换为“橘红色”

3. 根据疑问词的类型，一共有以下三种问答类型：

   - 介绍若干条商品，以疑问词”介绍“为开头：需要若干个商品名，返回商品表中这些商品的所有信息。<font color="green">例如介绍一下迪奥999和MAC316？</font>

   - 获取某个商品的若干条属性值，以疑问词”什么“、“多少”为开头：需要一个商品名，返回商品表中该商品的若干条属性值。<font color="green">例如MAC316的产地和色系是什么</font>？<font color="green">MAC316的价格是多少？</font>

   - 获取若干条商品，以疑问词“哪些”为开头：需要的是返回商品表中符合条件的的若干条商品<font color="green">例如200元左右的MAC口红有哪些？豆沙色或正红色的纪梵希口红有哪些？美国产的纪梵希口红有哪些？和MAC316价格类似的纪梵希口红有哪些？</font>

​	4.根据最后得到的句法树获得所有关键列名与列值，并根据疑问词类型构造sql语句。